import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';

class CountryCodePicker extends StatefulWidget {
  final String? initialCountryCode;
  final String? initialCountryFlag;
  final String? initialCountryName;
  final Function(String countryCode, String countryFlag, String countryName)
      onChanged;
  final bool enabled;

  const CountryCodePicker({
    super.key,
    this.initialCountryCode,
    this.initialCountryFlag,
    this.initialCountryName,
    required this.onChanged,
    this.enabled = true,
  });

  @override
  State<CountryCodePicker> createState() => _CountryCodePickerState();
}

class _CountryCodePickerState extends State<CountryCodePicker> {
  String _selectedCountryCode = '+967';
  String _selectedCountryFlag = 'üáæüá™';

  @override
  void initState() {
    super.initState();
    _loadSavedCountryCode();

    if (widget.initialCountryCode != null) {
      _selectedCountryCode = widget.initialCountryCode!;
      _selectedCountryFlag = widget.initialCountryFlag ?? 'üáæüá™';
    }
  }

  Future<void> _loadSavedCountryCode() async {
    final prefs = await SharedPreferences.getInstance();
    final savedCode = prefs.getString('last_country_code');
    final savedFlag = prefs.getString('last_country_flag');
    prefs.getString('last_country_name');

    if (savedCode != null && widget.initialCountryCode == null) {
      setState(() {
        _selectedCountryCode = savedCode;
        _selectedCountryFlag = savedFlag ?? 'üáæüá™';
      });
    }
  }

  Future<void> _saveCountryCode(String code, String flag, String name) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('last_country_code', code);
    await prefs.setString('last_country_flag', flag);
    await prefs.setString('last_country_name', name);
  }

  void _showCountryPicker() {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => CountryPickerBottomSheet(
        selectedCountryCode: _selectedCountryCode,
        onCountrySelected: (country) {
          setState(() {
            _selectedCountryCode = country.code;
            _selectedCountryFlag = country.flag;
          });
          _saveCountryCode(country.code, country.flag, country.name);
          widget.onChanged(country.code, country.flag, country.name);
        },
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: widget.enabled ? _showCountryPicker : null,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 16),
        decoration: BoxDecoration(
          border: Border.all(color: Colors.grey.shade300),
          borderRadius: const BorderRadius.only(
            topLeft: Radius.circular(8),
            bottomLeft: Radius.circular(8),
          ),
          color: widget.enabled ? Colors.white : Colors.grey.shade100,
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(
              _selectedCountryFlag,
              style: const TextStyle(fontSize: 20),
            ),
            const SizedBox(width: 8),
            Text(
              _selectedCountryCode,
              style: const TextStyle(
                fontSize: 16,
                fontWeight: FontWeight.w500,
              ),
            ),
            if (widget.enabled) ...[
              const SizedBox(width: 4),
              Icon(
                Icons.arrow_drop_down,
                color: Colors.grey.shade600,
                size: 20,
              ),
            ],
          ],
        ),
      ),
    );
  }
}

class CountryPickerBottomSheet extends StatefulWidget {
  final String selectedCountryCode;
  final Function(CountryInfo) onCountrySelected;

  const CountryPickerBottomSheet({
    super.key,
    required this.selectedCountryCode,
    required this.onCountrySelected,
  });

  @override
  State<CountryPickerBottomSheet> createState() =>
      _CountryPickerBottomSheetState();
}

class _CountryPickerBottomSheetState extends State<CountryPickerBottomSheet> {
  final TextEditingController _searchController = TextEditingController();
  List<CountryInfo> _filteredCountries = [];
  final TextEditingController _manualCodeController = TextEditingController();

  @override
  void initState() {
    super.initState();
    _filteredCountries = CountryData.countries;
  }

  void _filterCountries(String query) {
    setState(() {
      if (query.isEmpty) {
        _filteredCountries = CountryData.countries;
      } else {
        _filteredCountries = CountryData.countries.where((country) {
          return country.name.toLowerCase().contains(query.toLowerCase()) ||
              country.code.contains(query) ||
              country.nameAr.contains(query);
        }).toList();
      }
    });
  }

  void _addManualCode() {
    final code = _manualCodeController.text.trim();
    if (code.isNotEmpty && code.startsWith('+')) {
      final manualCountry = CountryInfo(
        name: 'ÿ±ŸÖÿ≤ ŸÖÿÆÿµÿµ',
        nameAr: 'ÿ±ŸÖÿ≤ ŸÖÿÆÿµÿµ',
        code: code,
        flag: 'üåç',
      );
      widget.onCountrySelected(manualCountry);
      Navigator.pop(context);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      height: MediaQuery.of(context).size.height * 0.8,
      decoration: const BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      child: Column(
        children: [
          // Handle bar
          Container(
            margin: const EdgeInsets.only(top: 8),
            width: 40,
            height: 4,
            decoration: BoxDecoration(
              color: Colors.grey.shade300,
              borderRadius: BorderRadius.circular(2),
            ),
          ),

          // Header
          Padding(
            padding: const EdgeInsets.all(16),
            child: Row(
              children: [
                const Expanded(
                  child: Text(
                    'ÿßÿÆÿ™ÿ± ÿ±ŸÖÿ≤ ÿßŸÑÿØŸàŸÑÿ©',
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
                IconButton(
                  onPressed: () => Navigator.pop(context),
                  icon: const Icon(Icons.close),
                ),
              ],
            ),
          ),

          // Search field
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16),
            child: TextField(
              controller: _searchController,
              decoration: InputDecoration(
                hintText: 'ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿØŸàŸÑÿ© ÿ£Ÿà ÿßŸÑÿ±ŸÖÿ≤...',
                prefixIcon: const Icon(Icons.search),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
                filled: true,
                fillColor: Colors.grey.shade50,
              ),
              onChanged: _filterCountries,
            ),
          ),

          const SizedBox(height: 16),

          // Manual code input
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16),
            child: Row(
              children: [
                Expanded(
                  child: TextField(
                    controller: _manualCodeController,
                    decoration: InputDecoration(
                      hintText: 'ÿ£Ÿà ÿßŸÉÿ™ÿ® ÿßŸÑÿ±ŸÖÿ≤ ŸäÿØŸàŸäÿßŸã (ŸÖÿ´ŸÑ: +966)',
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      filled: true,
                      fillColor: Colors.grey.shade50,
                    ),
                    keyboardType: TextInputType.phone,
                  ),
                ),
                const SizedBox(width: 8),
                ElevatedButton(
                  onPressed: _addManualCode,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF2E7D32),
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                  ),
                  child: const Text('ÿ•ÿ∂ÿßŸÅÿ©'),
                ),
              ],
            ),
          ),

          const SizedBox(height: 16),

          // Countries list
          Expanded(
            child: ListView.builder(
              itemCount: _filteredCountries.length,
              itemBuilder: (context, index) {
                final country = _filteredCountries[index];
                final isSelected = country.code == widget.selectedCountryCode;

                return ListTile(
                  leading: Text(
                    country.flag,
                    style: const TextStyle(fontSize: 24),
                  ),
                  title: Text(
                    country.nameAr,
                    style: const TextStyle(fontWeight: FontWeight.w500),
                  ),
                  subtitle: Text('${country.name} ${country.code}'),
                  trailing: isSelected
                      ? const Icon(Icons.check, color: Color(0xFF2E7D32))
                      : null,
                  selected: isSelected,
                  selectedTileColor: const Color(0xFF2E7D32).withOpacity(0.1),
                  onTap: () {
                    widget.onCountrySelected(country);
                    Navigator.pop(context);
                  },
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _searchController.dispose();
    _manualCodeController.dispose();
    super.dispose();
  }
}

class CountryInfo {
  final String name;
  final String nameAr;
  final String code;
  final String flag;

  CountryInfo({
    required this.name,
    required this.nameAr,
    required this.code,
    required this.flag,
  });
}

class CountryData {
  static final List<CountryInfo> countries = [
    CountryInfo(name: 'Yemen', nameAr: 'ÿßŸÑŸäŸÖŸÜ', code: '+967', flag: 'üáæüá™'),
    CountryInfo(
        name: 'Saudi Arabia', nameAr: 'ÿßŸÑÿ≥ÿπŸàÿØŸäÿ©', code: '+966', flag: 'üá∏üá¶'),
    CountryInfo(
        name: 'United Arab Emirates',
        nameAr: 'ÿßŸÑÿ•ŸÖÿßÿ±ÿßÿ™',
        code: '+971',
        flag: 'üá¶üá™'),
    CountryInfo(name: 'Egypt', nameAr: 'ŸÖÿµÿ±', code: '+20', flag: 'üá™üá¨'),
    CountryInfo(name: 'Jordan', nameAr: 'ÿßŸÑÿ£ÿ±ÿØŸÜ', code: '+962', flag: 'üáØüá¥'),
    CountryInfo(name: 'Lebanon', nameAr: 'ŸÑÿ®ŸÜÿßŸÜ', code: '+961', flag: 'üá±üáß'),
    CountryInfo(name: 'Syria', nameAr: 'ÿ≥Ÿàÿ±Ÿäÿß', code: '+963', flag: 'üá∏üáæ'),
    CountryInfo(name: 'Iraq', nameAr: 'ÿßŸÑÿπÿ±ÿßŸÇ', code: '+964', flag: 'üáÆüá∂'),
    CountryInfo(name: 'Kuwait', nameAr: 'ÿßŸÑŸÉŸàŸäÿ™', code: '+965', flag: 'üá∞üáº'),
    CountryInfo(name: 'Qatar', nameAr: 'ŸÇÿ∑ÿ±', code: '+974', flag: 'üá∂üá¶'),
    CountryInfo(name: 'Bahrain', nameAr: 'ÿßŸÑÿ®ÿ≠ÿ±ŸäŸÜ', code: '+973', flag: 'üáßüá≠'),
    CountryInfo(name: 'Oman', nameAr: 'ÿπŸèŸÖÿßŸÜ', code: '+968', flag: 'üá¥üá≤'),
    CountryInfo(
        name: 'Palestine', nameAr: 'ŸÅŸÑÿ≥ÿ∑ŸäŸÜ', code: '+970', flag: 'üáµüá∏'),
    CountryInfo(name: 'Morocco', nameAr: 'ÿßŸÑŸÖÿ∫ÿ±ÿ®', code: '+212', flag: 'üá≤üá¶'),
    CountryInfo(name: 'Algeria', nameAr: 'ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±', code: '+213', flag: 'üá©üáø'),
    CountryInfo(name: 'Tunisia', nameAr: 'ÿ™ŸàŸÜÿ≥', code: '+216', flag: 'üáπüá≥'),
    CountryInfo(name: 'Libya', nameAr: 'ŸÑŸäÿ®Ÿäÿß', code: '+218', flag: 'üá±üáæ'),
    CountryInfo(name: 'Sudan', nameAr: 'ÿßŸÑÿ≥ŸàÿØÿßŸÜ', code: '+249', flag: 'üá∏üá©'),
    CountryInfo(name: 'Somalia', nameAr: 'ÿßŸÑÿµŸàŸÖÿßŸÑ', code: '+252', flag: 'üá∏üá¥'),
    CountryInfo(name: 'Djibouti', nameAr: 'ÿ¨Ÿäÿ®Ÿàÿ™Ÿä', code: '+253', flag: 'üá©üáØ'),
    CountryInfo(
        name: 'Comoros', nameAr: 'ÿ¨ÿ≤ÿ± ÿßŸÑŸÇŸÖÿ±', code: '+269', flag: 'üá∞üá≤'),
    CountryInfo(
        name: 'Mauritania', nameAr: 'ŸÖŸàÿ±Ÿäÿ™ÿßŸÜŸäÿß', code: '+222', flag: 'üá≤üá∑'),
    CountryInfo(
        name: 'United States',
        nameAr: 'ÿßŸÑŸàŸÑÿßŸäÿßÿ™ ÿßŸÑŸÖÿ™ÿ≠ÿØÿ©',
        code: '+1',
        flag: 'üá∫üá∏'),
    CountryInfo(
        name: 'United Kingdom',
        nameAr: 'ÿßŸÑŸÖŸÖŸÑŸÉÿ© ÿßŸÑŸÖÿ™ÿ≠ÿØÿ©',
        code: '+44',
        flag: 'üá¨üáß'),
    CountryInfo(name: 'Germany', nameAr: 'ÿ£ŸÑŸÖÿßŸÜŸäÿß', code: '+49', flag: 'üá©üá™'),
    CountryInfo(name: 'France', nameAr: 'ŸÅÿ±ŸÜÿ≥ÿß', code: '+33', flag: 'üá´üá∑'),
    CountryInfo(name: 'Italy', nameAr: 'ÿ•Ÿäÿ∑ÿßŸÑŸäÿß', code: '+39', flag: 'üáÆüáπ'),
    CountryInfo(name: 'Spain', nameAr: 'ÿ•ÿ≥ÿ®ÿßŸÜŸäÿß', code: '+34', flag: 'üá™üá∏'),
    CountryInfo(
        name: 'Netherlands', nameAr: 'ŸáŸàŸÑŸÜÿØÿß', code: '+31', flag: 'üá≥üá±'),
    CountryInfo(name: 'Belgium', nameAr: 'ÿ®ŸÑÿ¨ŸäŸÉÿß', code: '+32', flag: 'üáßüá™'),
    CountryInfo(
        name: 'Switzerland', nameAr: 'ÿ≥ŸàŸäÿ≥ÿ±ÿß', code: '+41', flag: 'üá®üá≠'),
    CountryInfo(name: 'Austria', nameAr: 'ÿßŸÑŸÜŸÖÿ≥ÿß', code: '+43', flag: 'üá¶üáπ'),
    CountryInfo(name: 'Sweden', nameAr: 'ÿßŸÑÿ≥ŸàŸäÿØ', code: '+46', flag: 'üá∏üá™'),
    CountryInfo(name: 'Norway', nameAr: 'ÿßŸÑŸÜÿ±ŸàŸäÿ¨', code: '+47', flag: 'üá≥üá¥'),
    CountryInfo(name: 'Denmark', nameAr: 'ÿßŸÑÿØŸÜŸÖÿßÿ±ŸÉ', code: '+45', flag: 'üá©üá∞'),
    CountryInfo(name: 'Finland', nameAr: 'ŸÅŸÜŸÑŸÜÿØÿß', code: '+358', flag: 'üá´üáÆ'),
    CountryInfo(name: 'Russia', nameAr: 'ÿ±Ÿàÿ≥Ÿäÿß', code: '+7', flag: 'üá∑üá∫'),
    CountryInfo(name: 'China', nameAr: 'ÿßŸÑÿµŸäŸÜ', code: '+86', flag: 'üá®üá≥'),
    CountryInfo(name: 'Japan', nameAr: 'ÿßŸÑŸäÿßÿ®ÿßŸÜ', code: '+81', flag: 'üáØüáµ'),
    CountryInfo(
        name: 'South Korea',
        nameAr: 'ŸÉŸàÿ±Ÿäÿß ÿßŸÑÿ¨ŸÜŸàÿ®Ÿäÿ©',
        code: '+82',
        flag: 'üá∞üá∑'),
    CountryInfo(name: 'India', nameAr: 'ÿßŸÑŸáŸÜÿØ', code: '+91', flag: 'üáÆüá≥'),
    CountryInfo(name: 'Pakistan', nameAr: 'ÿ®ÿßŸÉÿ≥ÿ™ÿßŸÜ', code: '+92', flag: 'üáµüá∞'),
    CountryInfo(
        name: 'Bangladesh', nameAr: 'ÿ®ŸÜÿ∫ŸÑÿßÿØŸäÿ¥', code: '+880', flag: 'üáßüá©'),
    CountryInfo(name: 'Turkey', nameAr: 'ÿ™ÿ±ŸÉŸäÿß', code: '+90', flag: 'üáπüá∑'),
    CountryInfo(name: 'Iran', nameAr: 'ÿ•Ÿäÿ±ÿßŸÜ', code: '+98', flag: 'üáÆüá∑'),
    CountryInfo(
        name: 'Afghanistan', nameAr: 'ÿ£ŸÅÿ∫ÿßŸÜÿ≥ÿ™ÿßŸÜ', code: '+93', flag: 'üá¶üá´'),
    CountryInfo(
        name: 'Australia', nameAr: 'ÿ£ÿ≥ÿ™ÿ±ÿßŸÑŸäÿß', code: '+61', flag: 'üá¶üá∫'),
    CountryInfo(name: 'Canada', nameAr: 'ŸÉŸÜÿØÿß', code: '+1', flag: 'üá®üá¶'),
    CountryInfo(name: 'Brazil', nameAr: 'ÿßŸÑÿ®ÿ±ÿßÿ≤ŸäŸÑ', code: '+55', flag: 'üáßüá∑'),
    CountryInfo(
        name: 'Argentina', nameAr: 'ÿßŸÑÿ£ÿ±ÿ¨ŸÜÿ™ŸäŸÜ', code: '+54', flag: 'üá¶üá∑'),
    CountryInfo(name: 'Mexico', nameAr: 'ÿßŸÑŸÖŸÉÿ≥ŸäŸÉ', code: '+52', flag: 'üá≤üáΩ'),
    CountryInfo(
        name: 'South Africa',
        nameAr: 'ÿ¨ŸÜŸàÿ® ÿ£ŸÅÿ±ŸäŸÇŸäÿß',
        code: '+27',
        flag: 'üáøüá¶'),
    CountryInfo(name: 'Nigeria', nameAr: 'ŸÜŸäÿ¨Ÿäÿ±Ÿäÿß', code: '+234', flag: 'üá≥üá¨'),
    CountryInfo(name: 'Kenya', nameAr: 'ŸÉŸäŸÜŸäÿß', code: '+254', flag: 'üá∞üá™'),
    CountryInfo(
        name: 'Ethiopia', nameAr: 'ÿ•ÿ´ŸäŸàÿ®Ÿäÿß', code: '+251', flag: 'üá™üáπ'),
    CountryInfo(name: 'Ghana', nameAr: 'ÿ∫ÿßŸÜÿß', code: '+233', flag: 'üá¨üá≠'),
    CountryInfo(
        name: 'Tanzania', nameAr: 'ÿ™ŸÜÿ≤ÿßŸÜŸäÿß', code: '+255', flag: 'üáπüáø'),
    CountryInfo(name: 'Uganda', nameAr: 'ÿ£Ÿàÿ∫ŸÜÿØÿß', code: '+256', flag: 'üá∫üá¨'),
    CountryInfo(name: 'Rwanda', nameAr: 'ÿ±ŸàÿßŸÜÿØÿß', code: '+250', flag: 'üá∑üáº'),
    CountryInfo(name: 'Senegal', nameAr: 'ÿßŸÑÿ≥ŸÜÿ∫ÿßŸÑ', code: '+221', flag: 'üá∏üá≥'),
    CountryInfo(name: 'Mali', nameAr: 'ŸÖÿßŸÑŸä', code: '+223', flag: 'üá≤üá±'),
    CountryInfo(
        name: 'Burkina Faso',
        nameAr: 'ÿ®Ÿàÿ±ŸÉŸäŸÜÿß ŸÅÿßÿ≥Ÿà',
        code: '+226',
        flag: 'üáßüá´'),
    CountryInfo(name: 'Niger', nameAr: 'ÿßŸÑŸÜŸäÿ¨ÿ±', code: '+227', flag: 'üá≥üá™'),
    CountryInfo(name: 'Chad', nameAr: 'ÿ™ÿ¥ÿßÿØ', code: '+235', flag: 'üáπüá©'),
    CountryInfo(
        name: 'Cameroon', nameAr: 'ÿßŸÑŸÉÿßŸÖŸäÿ±ŸàŸÜ', code: '+237', flag: 'üá®üá≤'),
    CountryInfo(
        name: 'Central African Republic',
        nameAr: 'ÿ¨ŸÖŸáŸàÿ±Ÿäÿ© ÿ£ŸÅÿ±ŸäŸÇŸäÿß ÿßŸÑŸàÿ≥ÿ∑Ÿâ',
        code: '+236',
        flag: 'üá®üá´'),
    CountryInfo(
        name: 'Democratic Republic of Congo',
        nameAr: 'ÿ¨ŸÖŸáŸàÿ±Ÿäÿ© ÿßŸÑŸÉŸàŸÜÿ∫Ÿà ÿßŸÑÿØŸäŸÖŸÇÿ±ÿßÿ∑Ÿäÿ©',
        code: '+243',
        flag: 'üá®üá©'),
    CountryInfo(
        name: 'Republic of Congo',
        nameAr: 'ÿ¨ŸÖŸáŸàÿ±Ÿäÿ© ÿßŸÑŸÉŸàŸÜÿ∫Ÿà',
        code: '+242',
        flag: 'üá®üá¨'),
    CountryInfo(name: 'Gabon', nameAr: 'ÿßŸÑÿ∫ÿßÿ®ŸàŸÜ', code: '+241', flag: 'üá¨üá¶'),
    CountryInfo(
        name: 'Equatorial Guinea',
        nameAr: 'ÿ∫ŸäŸÜŸäÿß ÿßŸÑÿßÿ≥ÿ™Ÿàÿßÿ¶Ÿäÿ©',
        code: '+240',
        flag: 'üá¨üá∂'),
    CountryInfo(
        name: 'Sao Tome and Principe',
        nameAr: 'ÿ≥ÿßŸà ÿ™ŸàŸÖŸä Ÿàÿ®ÿ±ŸäŸÜÿ≥Ÿäÿ®Ÿä',
        code: '+239',
        flag: 'üá∏üáπ'),
    CountryInfo(
        name: 'Cape Verde', nameAr: 'ÿßŸÑÿ±ÿ£ÿ≥ ÿßŸÑÿ£ÿÆÿ∂ÿ±', code: '+238', flag: 'üá®üáª'),
  ];
}
